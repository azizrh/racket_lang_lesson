<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>S-Expression Practice</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121935; --muted:#8ea0c6; --text:#e8eeff; --accent:#6aa6ff; --ok:#31d061; --err:#ff6b6b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:linear-gradient(180deg,#0b1020,#0d1330 40%,#0e1738)}
    header{padding:20px 24px;border-bottom:1px solid #1c2550;background:rgba(0,0,0,.2);backdrop-filter: blur(6px);position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:20px;letter-spacing:.3px}
    main{display:grid;gap:18px;padding:18px;grid-template-columns: 1fr 1fr;align-items:start}
    @media (max-width: 980px){main{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid #1c2550;border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card header{position:static;background:transparent;border:0;padding:16px 16px 0}
    .card .content{padding:16px}
    .muted{color:var(--muted)}
    textarea,input,select,button{font:inherit;color:inherit}
    textarea{width:100%;min-height:300px;background:#0e1430;border:1px solid #243067;border-radius:12px;padding:12px;color:var(--text)}
    select{background:#0e1430;border:1px solid #243067;border-radius:12px;padding:8px 10px;color:var(--text)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .stack{display:grid;gap:12px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid #26306a;background:#0f1636;border-radius:999px;font-size:12px;color:var(--muted)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0b1130;border:1px solid #2a3574;border-bottom-width:2px;border-radius:6px;padding:2px 6px;color:#cfe2ff}
    .panel{background:#0e1430;border:1px dashed #2a3574;border-radius:12px;padding:12px}
    .input{width:100%;background:#0e1430;border:1px solid #243067;border-radius:12px;padding:12px}
    .btn{background:linear-gradient(180deg,#2563eb,#1d4ed8);border:0;color:white;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s transform, .2s filter;box-shadow:0 6px 18px rgba(37,99,235,.3)}
    .btn.secondary{background:#0f1636;border:1px solid #2a3574;color:#cfe2ff;box-shadow:none}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .status{border-radius:12px;padding:12px}
    .status.ok{background:rgba(49,208,97,.1);border:1px solid rgba(49,208,97,.35)}
    .status.err{background:rgba(255,107,107,.08);border:1px solid rgba(255,107,107,.35)}
    .small{font-size:12px}
    code{background:#0b1130;border:1px solid #2a3574;border-radius:8px;padding:1px 6px}
    .footer{padding:10px 16px;border-top:1px solid #1c2550;display:flex;justify-content:space-between;align-items:center;gap:8px;border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius)}
    /* Modal */
        /* replace your existing .modal rule with this */
    .modal{
      /* visible by default; x-show will hide it by adding inline display:none */
      display:flex;
      position:fixed;
      z-index:100;
      left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,.6);
      align-items:center; justify-content:center;
    }

    /* hide any x-cloak elements until Alpine is ready */
    [x-cloak] { display: none !important; }

    .modal-content{background:#121935;padding:20px;border-radius:16px;max-width:420px;text-align:center;border:1px solid #1c2550}
    .modal-content h2{margin:4px 0 10px}
    .lesson-display {white-space: pre-wrap;background:#0e1430;border:1px solid #243067;border-radius:12px;padding:12px;color:var(--text);}
    .lesson-display p {margin: 0 0 0.5em;}
    .lesson-display code {font-family: monospace;background:#0b1130;border:1px solid #2a3574;border-radius:6px;padding:2px 4px;}
  </style>
</head>
<body x-data="app()" x-init="init()" @keydown.window.enter.prevent="if(!$event.shiftKey && !$event.ctrlKey){ check() }" @keydown.window.ctrl.enter.prevent="reveal()">
  <header>
    <h1>S-Expression Practice • Lesson + Validator</h1>
  </header>

  <main>
    <!-- LEFT: Lesson text -->
    <section class="card" id="lessonCard">
      <header>
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0;font-size:18px">Lesson</h2>
          <div class="row">
            <span class="pill">Tip: press <span class="kbd">Enter</span> on the right to check</span>
          </div>
        </div>
        <div class="row" style="margin:10px 0 0">
          <!-- Lesson navigation -->
          <button class="btn secondary" id="lessonPrevBtn" :disabled="!hasMultipleLessons" @click="setLessonByIndex(lessonIdx - 1)">◀ Prev lesson</button>
          <select id="lessonSelect" aria-label="Choose lesson" x-model="selectedLessonId" @change="setLessonById(selectedLessonId)">
            <template x-for="l in lessons" :key="l.id">
              <option :value="String(l.id)" x-text="`${l.title} (ID ${l.id})`"></option>
            </template>
          </select>
          <button class="btn secondary" id="lessonNextBtn" :disabled="!hasMultipleLessons" @click="setLessonByIndex(lessonIdx + 1)">Next lesson ▶</button>
        </div>
      </header>
      <div class="content">
        <div class="stack">
          <div id="lessonText" class="lesson-display" x-html="lessonBodyHtml"></div>
          <div class="row" style="justify-content:flex-end">
            <button class="btn secondary" id="refreshLessonBtn" hidden @click="refreshLesson()">Refresh from server</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Problems & validator -->
    <section class="card" id="practiceCard">
      <header>
        <h2 style="margin:0 0 6px 0;font-size:18px">Problems & Validator</h2>
        <div class="muted small" x-show="false">Your answer is validated by the backend (CFG or Racket), based on the lesson/problem config.</div>
      </header>
      <div class="content">
        <div class="stack">
          <div class="row" style="justify-content:space-between;align-items:center" x-show="false">
            <div class="row" style="gap:16px" hidden>
              <label class="pill" hidden><input type="checkbox" id="naryToggle" x-model="allowNary"  /> Allow n-ary (≥2 operands)</label>
              <label class="pill" hidden><input type="checkbox" id="allowNeg" x-model="allowNeg"/> Allow negative integers</label>
            </div>
            <div class="row">
              <button class="btn secondary" id="prevBtn" @click="prevProblem()">◀ Prev</button>
              <button class="btn secondary" id="nextBtn" @click="nextProblem()">Next ▶</button>
            </div>
          </div>

          <div class="panel">
            <div class="muted small">Problem</div>
            <div id="problemText" style="font-size:22px;margin-top:6px" x-text="currentProblem ? cleanProblemText(currentProblem.prompt_text) : 'No problems found for this lesson.'"></div>
          </div>

          <label class="muted small" for="answerInput">Your answer</label>
          <input id="answerInput" class="input" placeholder="e.g. (+ 5 4) or Racket code" autocomplete="off" x-model="answer" x-ref="answerInput" />

          <div class="row" style="justify-content:flex-start;gap:10px">
            <button class="btn" id="checkBtn" @click="check">Check (Enter)</button>
            <button class="btn secondary" id="revealBtn" @click="reveal">Reveal answer</button>
            <button class="btn secondary" id="shuffleBtn" @click="shuffle" x-show="false">Shuffle</button>
          </div>

          <div id="result" class="status" x-show="resultVisible" :class="resultOk ? 'ok' : 'err'" x-text="resultMessage"></div>
        </div>
      </div>
      <div class="footer small muted">
        <div>Keyboard: <span class="kbd">Enter</span> to check • <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> to reveal</div>
      </div>
    </section>
  </main>

<!-- add x-cloak so it starts hidden until Alpine initializes -->
<div class="modal" id="congratsModal" x-cloak x-show="showModal" x-transition.opacity>
  <div class="modal-content" x-transition.scale>
    <h2>🎉 Congratulations!</h2>
    <p>You solved 3 problems correctly in a row!</p>
    <div class="row" style="justify-content:center;margin-top:12px;gap:10px">
      <button class="btn" id="keepGoingBtn" @click="confirmAdvanceLesson()">Keep going</button>
      <button class="btn secondary" id="resetCounterBtn" @click="resetStreakAndStay()">Stay &amp; reset</button>
    </div>
  </div>
</div>


  <!-- deps -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Alpine app -->
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('app', () => ({
        // ====== Config ======
        API_BASE: "http://localhost:8000",

        // ====== State ======
        lessons: [],          // [{id,title,body_md}, ...]
        lessonIdx: 0,
        problems: [],         // problems for current lesson
        problemIdx: 0,
        successCount: 0,
        selectedLessonId: null,
        answer: '',
        lessonBodyHtml: '',
        resultVisible: false,
        resultOk: false,
        resultMessage: '',
        allowNary: false,
        allowNeg: false,
        showModal: false,

        // Auto-advance per problem
        advanceOnCorrect: true,
        advanceDelayMs: 900,
        advanceTimerId: null,
        clearAdvanceTimer(){
          if (this.advanceTimerId){ clearTimeout(this.advanceTimerId); this.advanceTimerId = null; }
        },

        // ====== Derived ======
        get hasMultipleLessons(){ return this.lessons.length > 1; },
        get currentLesson(){ return this.lessons[this.lessonIdx] || null; },
        get currentProblem(){ return this.problems[this.problemIdx] || null; },
        get cfgText(){ return this.getCfgText(this.allowNary, this.allowNeg); },

        // ====== Lifecycle ======
        async init(){
          await this.bootstrap();
        },

        async bootstrap(){
          try{
            this.lessons = await this.listLessons();
            if(this.lessons.length){
              this.selectedLessonId = String(this.lessons[0].id);
              await this.setLessonByIndex(0);
            } else {
              this.setResult(false, 'No lessons found. Please add one in the database.');
            }
          } catch (err){
            console.error(err);
            this.setResult(false, err?.message || 'Failed to load lessons.');
          }
        },

        // ====== Backend I/O ======
        async listLessons(){
          const res = await fetch(`${this.API_BASE}/lessons`);
          if(!res.ok) throw new Error('Failed to list lessons');
          return await res.json();
        },
        async loadLesson(lessonId){
          const res = await fetch(`${this.API_BASE}/lessons/${lessonId}`);
          if(!res.ok) throw new Error('Lesson not found');
          return await res.json();
        },
        async loadProblems(lessonId){
          const res = await fetch(`${this.API_BASE}/lessons/${lessonId}/problems`);
          if(!res.ok) throw new Error('Failed to load problems');
          return await res.json();
        },
        async backendValidate(problemId, submission){
          const res = await fetch(`${this.API_BASE}/validate`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ problem_id: problemId, submission })
          });
          if(!res.ok){
            const text = await res.text().catch(()=> "");
            throw new Error(`Backend error (${res.status}): ${text || 'unknown'}`);
          }
          return await res.json();
        },
        async recordAttempt(problemId, submission, backendResult){
          try{
            await fetch(`${this.API_BASE}/attempts`, {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({
                problem_id: problemId,
                submitted_text: submission,
                is_correct: !!backendResult.ok,
                stage: backendResult.stage || null,
                error_reason: backendResult.ok ? null : (backendResult.error || null),
                details: backendResult.details || null
              })
            });
          } catch(e){
            console.warn('Failed to record attempt:', e);
          }
        },

        // ====== Helpers ======
        cleanProblemText(raw){
          if (typeof raw !== 'string') return '';
          return raw.replaceAll('\\n', '\n').trim();
        },
        setLessonBody(md){
          this.lessonBodyHtml = (window.marked ? marked.parse(md || '') : md || '');
        },
        setResult(ok, msg){
          this.resultOk = !!ok;
          this.resultMessage = (ok ? '✅ ' : '❌ ') + (msg || '');
          this.resultVisible = true;
        },
        hideResult(){ this.resultVisible = false; },

        getCfgText(nary, allowNeg){
          return (
`S        ::= WS? Expr WS?

Expr     ::= Int
           | "(" WS? Op WS Expr ` + (nary ? '(WS Expr)+' : 'WS Expr') + ` WS? ")"

Op       ::= "+" | "-" | "*"

Int      ::= ` + (allowNeg ? `["-"] ("0" | NonZeroDigit {Digit})` : `"0" | NonZeroDigit {Digit}`) + `
Digit    ::= "0" | NonZeroDigit
NonZeroDigit ::= "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9"

WS       ::= {" " | "\\t" | "\\n" | "\\r"}`
          );
        },

        // ====== UI Actions ======
        async setLessonByIndex(newIdx){
          if (!this.lessons.length) return;
          this.lessonIdx = (newIdx + this.lessons.length) % this.lessons.length;
          const current = this.lessons[this.lessonIdx];
          this.selectedLessonId = String(current.id);

          // Load latest lesson body
          const freshLesson = await this.loadLesson(current.id);
          this.setLessonBody(this.cleanProblemText(freshLesson.body_md) || '');

          // Load problems
          this.problems = await this.loadProblems(current.id);
          this.problemIdx = 0;
          this.successCount = 0; // reset streak on lesson change
          this.showProblem();
        },
        async setLessonById(id){
          const idx = this.lessons.findIndex(l => l.id === Number(id));
          if (idx >= 0) {
            await this.setLessonByIndex(idx);
          }
        },
        async refreshLesson(){
          if (!this.lessons.length) return;
          const current = this.lessons[this.lessonIdx];
          const lesson = await this.loadLesson(current.id);
          this.setLessonBody(this.cleanProblemText(lesson.body_md) || '');
        },

        showProblem(){
          this.clearAdvanceTimer();
          this.answer = '';
          this.hideResult();
          this.$nextTick(()=> { this.$refs.answerInput?.focus(); });
        },

        prevProblem(){
          if(!this.problems.length) return;
          this.clearAdvanceTimer();
          this.problemIdx = (this.problemIdx - 1 + this.problems.length) % this.problems.length;
          this.showProblem();
        },

        nextProblem(){
          if(!this.problems.length) return;
          this.clearAdvanceTimer();
          this.problemIdx = (this.problemIdx + 1) % this.problems.length;
          this.showProblem();
        },

        async check(){
          const input = (this.answer || '').trim();
          if(!input){ this.setResult(false, 'Type your answer first'); return; }

          try{
            const p = this.currentProblem;
            if(!p){ this.setResult(false, 'No problem selected'); return; }
            const res = await this.backendValidate(p.id, input);

            // Record attempt (fire-and-forget)
            this.recordAttempt(p.id, input, res);

            if (res.ok){
              const stage = res.stage ? ` (${res.stage})` : '';
              this.setResult(true, 'Correct!' + stage);
              this.successCount++;

              // If third success, open modal asking to go to next lesson
              if (this.successCount >= 3){
                this.openCongrats();
              }

              // Auto-advance to the next problem unless modal is open
              if (this.advanceOnCorrect){
                this.clearAdvanceTimer();
                this.advanceTimerId = setTimeout(() => {
                  if (!this.showModal) {
                    this.nextProblem();
                  }
                  this.clearAdvanceTimer();
                }, this.advanceDelayMs);
              }
            } else {
              let msg = res.error || 'Incorrect.';
              if (res.details && res.details.failures) {
                const f = res.details.failures[0];
                if (f && f.expr) msg += `\nFailed test: ${f.expr}`;
              }
              this.setResult(false, msg);
              // Optionally reset streak here if you want strict "in a row":
              // this.successCount = 0;
            }
          } catch(e){
            this.setResult(false, e.message || 'Backend validation failed.');
          }
        },

        reveal(){
          const ans = this.currentProblem?.answer_text || 'N/A';
          this.setResult(true, 'Answer: ' + ans);
        },

        shuffle(){
          for(let i=this.problems.length-1;i>0;i--){
            const j=Math.floor(Math.random()*(i+1));
            [this.problems[i], this.problems[j]] = [this.problems[j], this.problems[i]];
          }
          this.problemIdx = 0;
          this.showProblem();
        },

        // ====== Modal controls for next-lesson flow ======
        openCongrats(){ this.showModal = true; },
        closeCongrats(){ this.showModal = false; },

        confirmAdvanceLesson(){
          // User chose to continue to next lesson
          this.closeCongrats();
          this.successCount = 0; // reset for the new lesson
          this.setLessonByIndex(this.lessonIdx + 1);
        },
        resetStreakAndStay(){
          // User chose to stay in current lesson but reset streak
          this.successCount = 0;
          this.closeCongrats();
        },
      }));
    });
  </script>
</body>
</html>
