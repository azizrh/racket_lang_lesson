<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>S-Expression Practice</title>

  <!-- Tailwind for layout utilities (CDN for convenience) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* =====================
       shadcn-inspired tokens (grayscale)
       ===================== */
    :root{
      /* HSL values only; we use them via hsl(var(--token)) */
      --background: 0 0% 6%;      /* ~#0f0f0f */
      --foreground: 0 0% 96%;     /* ~#f5f5f5 */
      --muted-foreground: 0 0% 65%;
      --card: 0 0% 9%;            /* ~#171717 */
      --popover: 0 0% 10%;
      --border: 0 0% 20%;
      --input: 0 0% 22%;
      --ring: 0 0% 45%;
      --radius: 16px;
      --sticky-top: 86px;         /* computed on init */
    }

    /* Base */
    *{box-sizing:border-box}
    body{
      margin:0;
      font:16px/1.5 system-ui, Segoe UI, Roboto, Helvetica, Arial;
      color: hsl(var(--foreground));
      background:
        radial-gradient(1200px 600px at 70% -10%, rgba(255,255,255,0.04), transparent),
        linear-gradient(180deg, hsl(var(--background)), hsl(0 0% 8%) 40%, hsl(0 0% 10%));
    }

    a { color: inherit; text-decoration: none; }

    /* Header */
    header{
      position:sticky; top:0; z-index:50;
      border-bottom:1px solid hsl(var(--border));
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
    }
    header .wrap{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:18px 20px; max-width: 1100px; margin: 0 auto; }
    header h1{ margin:0; font-size:15px; letter-spacing:.25px; color: hsl(var(--muted-foreground)); font-weight:600; }

    /* Layout */
    main{ display:grid; gap:18px; padding:18px; grid-template-columns: 1fr 1fr; align-items:start; max-width:1100px; margin:0 auto; }
    @media (max-width: 980px){ main{ grid-template-columns:1fr } }
    header .wrap,
    main { max-width: min(92rem, 95vw); }  /* ~1472px or 95% of viewport */

    /* Card */
    .card{ background:hsl(var(--card)); border:1px solid hsl(var(--border)); border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.35); }
    .card header{ position:static; background:transparent; border:0; padding:16px 16px 0 }
    .card .content{ padding:16px }

    /* Text helpers */
    .muted{ color: hsl(var(--muted-foreground)); }
    .small{ font-size:12px }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:hsl(0 0% 10%); border:1px solid hsl(var(--border)); border-bottom-width:2px; border-radius:6px; padding:2px 6px; color:hsl(var(--foreground)); }

    /* Inputs */
    textarea, input, select, button { font: inherit; color: inherit; }
    textarea, .input{
      width:100%; min-height: unset;
      background:hsl(0 0% 8%);
      border:1px solid hsl(var(--input));
      border-radius:12px; padding:12px; color: hsl(var(--foreground));
    }
    textarea{ min-height:300px }
    select{
      background:hsl(0 0% 8%);
      min-height:50px;
      text-align-last: left;
      /* text-indent: 8px; */
      border:3px solid hsl(var(--input));
      border-radius:10px; padding:8px 16px 8px 16px; color:hsl(var(--foreground));
    }
    .input:focus, textarea:focus, select:focus { outline: 2px solid hsl(var(--ring)); outline-offset: 2px; }

    /* Badges/Pills */
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border:1px solid hsl(var(--border)); background:hsl(0 0% 8%); border-radius:999px; font-size:12px; color:hsl(var(--muted-foreground)); }

    /* Panels */
    .panel{ background:hsl(0 0% 8%); border:1px dashed hsl(var(--input)); border-radius:12px; padding:12px }

    /* Buttons (shadcn-like: primary / ghost) */
    .btn{ display:inline-flex; align-items:center; gap:.5rem; border-radius:12px; padding:10px 14px; cursor:pointer; border:1px solid hsl(var(--border)); transition: transform .15s ease, background-color .2s ease, border-color .2s ease, opacity .2s ease; }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    .btn:focus-visible{ outline:2px solid hsl(var(--ring)); outline-offset:2px; }

    /* primary = high-contrast */
    .btn.primary{ background: hsl(var(--foreground)); color: hsl(var(--background)); border-color: hsl(0 0% 80%); }
    .btn.primary:hover{ background: hsl(0 0% 92%); }

    /* secondary (ghost) */
    .btn.secondary{ background: hsl(0 0% 10%); color: hsl(var(--foreground)); border-color: hsl(var(--input)); }
    .btn.secondary:hover{ background: hsl(0 0% 12%); }

    /* Status (monochrome) */
    .status{ border-radius:12px; padding:12px; border:1px solid hsl(var(--border)); background:hsl(0 0% 10%); }
    .status.ok{ /* keep monochrome; success icon comes from text */ }
    .status.err{ /* same base; relies on ‚ùå prefix */ }

    code{ background:hsl(0 0% 10%); border:1px solid hsl(var(--border)); border-radius:8px; padding:1px 6px }

    .footer{ padding:10px 16px; border-top:1px solid hsl(var(--border)); display:flex; justify-content:space-between; align-items:center; gap:8px; border-bottom-left-radius:var(--radius); border-bottom-right-radius:var(--radius) }

    @media (min-width: 981px){
      #practiceCard{ position: sticky; top: var(--sticky-top); align-self: start; }
    }

    /* Modal */
    .modal{ display:flex; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,.6); align-items:center; justify-content:center; padding: 16px; }
    .modal-content{ background:hsl(var(--card)); padding:20px; border-radius:16px; max-width:520px; width:100%; text-align:center; border:1px solid hsl(var(--border)); outline:none; box-shadow: 0 20px 60px rgba(0,0,0,.5); }
    .modal-content h2{ margin:4px 0 10px }

    /* Lesson text */
    .lesson-display { white-space: pre-wrap; background:hsl(0 0% 8%); border:1px solid hsl(var(--input)); border-radius:12px; padding:12px; color: hsl(var(--foreground)); }
    .lesson-display p { margin: 0 0 0.5em; }
    .lesson-display code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:hsl(0 0% 10%); border:1px solid hsl(var(--border)); border-radius:6px; padding:2px 4px; }

    /* Vue transitions */
    .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    .scale-enter-active, .scale-leave-active { transition: transform 0.3s ease, opacity 0.3s ease; }
    .scale-enter-from, .scale-leave-to { transform: scale(0.95); opacity: 0; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Header -->
    <header>
      <div class="wrap">
        <h1>S-Expression Practice ‚Ä¢ Lesson + Validator</h1>
        <div class="flex items-center gap-2">
          <span v-if="username" class="pill">Signed in as <strong>{{ username }}</strong></span>
          <button v-if="!username" class="btn secondary" @click="openLogin()">Sign in</button>
          <button v-if="username" class="btn secondary" @click="logout()">Log out</button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main :style="showLogin ? 'filter: blur(2px); pointer-events:none; user-select:none;' : ''">
      <!-- LEFT: Lesson text -->
      <section class="card" id="lessonCard">
        <header>
          <div class="flex items-center justify-between">
            <h2 class="m-0 text-[18px] font-semibold">Lesson</h2>
          </div>
          <div class="flex items-center gap-2 mt-2">
            <!-- Lesson navigation -->
            <button class="btn secondary" :disabled="!hasMultipleLessons" @click="setLessonByIndex(lessonIdx - 1)">‚óÄ Prev lesson</button>
            <select aria-label="Choose lesson" v-model="selectedLessonId" @change="setLessonById(selectedLessonId)">
              <option 
                v-for="l in lessons" 
                :key="l.id"
                :value="String(l.id)" 
                :disabled="!hasAccessToLesson(l.id)"
              >
                {{ (hasAccessToLesson(l.id) ? '' : 'üîí ') + `${l.title} (ID ${l.id})` }}
              </option>
            </select>
            <button class="btn secondary" :disabled="!hasMultipleLessons || !hasAccessToLesson(nextLessonId())" @click="setLessonByIndex(lessonIdx + 1)">Next lesson ‚ñ∂</button>
          </div>
        </header>
        <div class="content">
          <div class="grid gap-3">
            <div class="lesson-display" v-html="lessonBodyHtml"></div>
            <div class="flex justify-end">
              <button class="btn secondary" style="display: none;" @click="refreshLesson()">Refresh from server</button>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT: Problems & validator -->
      <section class="card" id="practiceCard">
        <header>
          <h2 class="m-0 mb-1 text-[18px] font-semibold">Problems &amp; Validator</h2>
        </header>
        <div class="content">
          <div class="grid gap-3">
            <div class="panel">
              <div class="muted small">Problem</div>
              <div class="mt-1 text-[22px]">{{ currentProblem ? cleanProblemText(currentProblem.prompt_text) : 'No problems found for this lesson.' }}</div>
              <div v-if="isRevealed" class="pill mt-2">Revealed ‚Äî answers for this problem won't be accepted</div>
            </div>

            <label class="muted small" for="answerInput">Your answer</label>
            <input 
              id="answerInput" 
              class="input" 
              placeholder="e.g. (+ 5 4) or Racket code" 
              autocomplete="off" 
              v-model="answer" 
              ref="answerInput" 
              :disabled="isRevealed"
              @keydown.enter.exact.prevent="check"
              @keydown.ctrl.enter.exact.prevent="reveal"
            />

            <div class="flex items-center gap-2">
              <button class="btn primary" :disabled="isRevealed" @click="check">Check (‚Üµ)</button>
              <button class="btn secondary" :disabled="isRevealed" @click="reveal">Reveal (Ctrl + ‚Üµ)</button>
            </div>

            <div v-if="resultVisible" class="status" :class="resultOk ? 'ok' : 'err'">{{ resultMessage }}</div>
          </div>
        </div>
      </section>
    </main>

    <!-- Congrats Modal (3-in-a-row) -->
    <transition name="fade">
      <div v-if="showModal" class="modal">
        <transition name="scale">
          <div class="modal-content">
            <h2>üéâ Congratulations!</h2>
            <p>You solved 3 problems correctly in a row!</p>
            <div class="flex justify-center gap-2 mt-3">
              <button class="btn primary" @click="confirmAdvanceLesson()">Unlock next lesson</button>
              <button class="btn secondary" @click="resetStreakAndStay()">Stay &amp; reset</button>
            </div>
          </div>
        </transition>
      </div>
    </transition>

    <!-- Reveal Confirm Modal -->
    <transition name="fade">
      <div v-if="showRevealConfirm" class="modal">
        <transition name="scale">
          <div 
            class="modal-content" 
            tabindex="0" 
            ref="revealModal"
            @keydown.escape.prevent.stop="cancelReveal()" 
            @keydown.enter.prevent.stop="confirmReveal()"
          >
            <h2>Reveal answer?</h2>
            <p class="muted small -mt-1">If you reveal, this problem will be skipped and we'll move to the next problem. It won't count toward your streak.</p>
            <div class="flex justify-center gap-2 mt-3">
              <button class="btn primary" @click="confirmReveal()">Reveal &amp; Skip to Next Problem</button>
              <button class="btn secondary" @click="cancelReveal()">Cancel</button>
            </div>
          </div>
        </transition>
      </div>
    </transition>

    <!-- Login Modal (username-based) -->
    <transition name="fade">
      <div v-if="showLogin" class="modal">
        <transition name="scale">
          <div 
            class="modal-content" 
            tabindex="0" 
            ref="loginModal"
            @keydown.enter.stop.prevent="loginWithUsername()"
          >
            <h2>Sign in</h2>
            <p class="muted small -mt-1">Enter a username to start or continue. We'll create your account if it doesn't exist.</p>

            <div class="grid gap-3 text-left mt-3">
              <div class="panel">
                <div class="flex items-center gap-2">
                  <input class="input flex-1" placeholder="Your username (e.g. alice)" v-model="loginUsername" />
                  <button class="btn secondary" @click="loginWithUsername()">Continue</button>
                </div>
              </div>
              <div v-if="loginError" class="status small">{{ loginError }}</div>
            </div>
          </div>
        </transition>
      </div>
    </transition>
  </div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          // ====== Config ======
          API_BASE: "http://localhost:8000",

          // ====== User/Auth State (username-first) ======
          username: null,
          userId: null,
          user: null,
          showLogin: false,
          loginUsername: '',
          loginError: '',
          creatingUser: false,

          // ====== Lesson/Practice State ======
          lessons: [],
          lessonIdx: 0,
          problems: [],
          problemIdx: 0,
          successCount: 0,
          selectedLessonId: null,
          answer: '',
          lessonBodyHtml: '',
          resultVisible: false,
          resultOk: false,
          resultMessage: '',
          allowNary: false,
          allowNeg: false,
          showModal: false,
          showRevealConfirm: false,
          revealedById: {},

          // Auto-advance per problem
          advanceOnCorrect: true,
          advanceDelayMs: 3000,
          advanceTimerId: null,
        }
      },

      computed: {
        hasMultipleLessons() {
          return this.lessons.length > 1;
        },
        currentLesson() {
          return this.lessons[this.lessonIdx] || null;
        },
        currentProblem() {
          return this.problems[this.problemIdx] || null;
        },
        cfgText() {
          return this.getCfgText(this.allowNary, this.allowNeg);
        },
        isRevealed() {
          return !!(this.currentProblem && this.revealedById[this.currentProblem.id]);
        }
      },

      methods: {
        hasAccessToLesson(id) {
          return !!this.user?.lessons?.includes(Number(id));
        },

        nextLessonId() {
          if (!this.lessons.length) return null;
          const ordered = this.lessons.map(l => l.id);
          const curId = this.currentLesson?.id;
          const i = ordered.indexOf(curId);
          return (i >= 0 && i < ordered.length - 1) ? ordered[i + 1] : null;
        },

        clearAdvanceTimer() {
          if (this.advanceTimerId) {
            clearTimeout(this.advanceTimerId);
            this.advanceTimerId = null;
          }
        },

        // ====== Lifecycle ======
        async init() {
          // Compute sticky top from header height
          try {
            const h = document.querySelector('header');
            if (h) {
              const updateStickyTop = () => {
                document.documentElement.style.setProperty('--sticky-top', (h.offsetHeight + 12) + 'px');
              };
              updateStickyTop();
              new ResizeObserver(updateStickyTop).observe(h);
            }
          } catch (e) {
            console.warn('Failed to setup sticky header:', e);
          }

          // Try load user from localStorage first
          this.loadLocalUser();
          if (this.username) {
            try {
              this.user = await this.getUserByUsername(this.username);
              this.userId = this.user?.user_id || null;
              await this.bootstrapLessons();
            } catch (e) {
              console.warn('Stored username invalid, clearing.', e);
              this.logout(true);
              this.openLogin();
            }
          } else {
            this.openLogin();
          }
        },

        async bootstrapLessons() {
          try {
            this.lessons = await this.listLessons();
            if (this.lessons.length) {
              const preferredId = this.user?.active_lesson || this.lessons[0].id;
              this.selectedLessonId = String(preferredId);
              await this.setLessonById(preferredId);
            } else {
              this.setResult(false, 'No lessons found. Please add one in the database.');
            }
          } catch (err) {
            console.error(err);
            this.setResult(false, err?.message || 'Failed to load lessons.');
          }
        },

        // ====== Backend I/O: Users (username-first) ======
        async loginWithUsername() {
          this.loginError = '';
          const uname = (this.loginUsername || '').trim();
          if (!uname) {
            this.loginError = 'Please enter a username.';
            return;
          }
          try {
            const res = await fetch(`${this.API_BASE}/login`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: uname })
            });
            if (!res.ok) {
              const text = await res.text().catch(() => '');
              throw new Error(text || `Login failed (${res.status})`);
            }
            const user = await res.json();
            this.setUser(user);
            this.closeLogin();
            await this.bootstrapLessons();
          } catch (e) {
            console.error(e);
            this.loginError = e?.message || 'Failed to log in.';
          }
        },

        async getUserByUsername(uname) {
          const res = await fetch(`${this.API_BASE}/users/by-username/${encodeURIComponent(uname)}`);
          if (!res.ok) {
            const text = await res.text().catch(() => '');
            throw new Error(text || `Failed to load user (${res.status})`);
          }
          return await res.json();
        },

        setUser(user) {
          this.user = user || null;
          this.username = user?.username || null;
          this.userId = user?.user_id || null;
          if (this.username) {
            localStorage.setItem('username', this.username);
          }
        },

        loadLocalUser() {
          const raw = localStorage.getItem('username');
          this.username = raw || null;
        },

        logout(silent = false) {
          localStorage.removeItem('username');
          this.user = null;
          this.username = null;
          this.userId = null;
          // Clear UI
          this.answer = '';
          this.problems = [];
          this.lessons = [];
          this.lessonIdx = 0;
          this.problemIdx = 0;
          if (!silent) this.openLogin();
        },

        openLogin() {
          this.showLogin = true;
          this.loginUsername = this.username || '';
          this.loginError = '';
          this.$nextTick(() => {
            if (this.$refs.loginModal) {
              this.$refs.loginModal.focus();
            }
          });
        },

        closeLogin() {
          this.showLogin = false;
        },

        // ====== Backend I/O: Lessons/Problems/Validation/Attempts ======
        async listLessons() {
          const res = await fetch(`${this.API_BASE}/lessons`);
          if (!res.ok) throw new Error('Failed to list lessons');
          return await res.json();
        },

        async loadLesson(lessonId) {
          const res = await fetch(`${this.API_BASE}/lessons/${lessonId}`);
          if (!res.ok) throw new Error('Lesson not found');
          return await res.json();
        },

        async loadProblems(lessonId) {
          const res = await fetch(`${this.API_BASE}/lessons/${lessonId}/problems`);
          if (!res.ok) throw new Error('Failed to load problems');
          return await res.json();
        },

        async backendValidate(problemId, submission) {
          const res = await fetch(`${this.API_BASE}/validate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ problem_id: problemId, submission })
          });
          if (!res.ok) {
            const text = await res.text().catch(() => "");
            throw new Error(`Backend error (${res.status}): ${text || 'unknown'}`);
          }
          return await res.json();
        },

        async recordAttempt(problemId, submission, backendResult) {
          if (!this.username) return;
          try {
            await fetch(`${this.API_BASE}/attempts`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                username: this.username,
                problem_id: problemId,
                submitted_text: submission,
                is_correct: !!backendResult.ok,
                stage: backendResult.stage || null,
                error_reason: backendResult.ok ? null : (backendResult.error || null),
                details: backendResult.details || null
              })
            });
          } catch (e) {
            console.warn('Failed to record attempt:', e);
          }
        },

        // ====== Helpers ======
        cleanProblemText(raw) {
          if (typeof raw !== 'string') return '';
          return raw.replaceAll('\\n', '\n').trim();
        },

        setLessonBody(md) {
          this.lessonBodyHtml = (window.marked ? marked.parse(md || '') : md || '');
        },

        setResult(ok, msg) {
          this.resultOk = !!ok;
          this.resultMessage = (ok ? '‚úÖ ' : '‚ùå ') + (msg || '');
          this.resultVisible = true;
        },

        hideResult() {
          this.resultVisible = false;
        },

        getCfgText(nary, allowNeg) {
          return (
            `S        ::= WS? Expr WS?

Expr     ::= Int
           | "(" WS? Op WS Expr ` + (nary ? '(WS Expr)+' : 'WS Expr') + ` WS? ")"

Op       ::= "+" | "-" | "*"

Int      ::= ` + (allowNeg ? `["-"] ("0" | NonZeroDigit {Digit})` : `"0" | NonZeroDigit {Digit}`) + `
Digit    ::= "0" | NonZeroDigit
NonZeroDigit ::= "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9"

WS       ::= {" " | "\t" | "\n" | "\r"}`
          );
        },

        // ====== UI Actions ======
        async setLessonByIndex(newIdx) {
          if (!this.lessons.length) return;
          const idx = (newIdx + this.lessons.length) % this.lessons.length;
          const target = this.lessons[idx];
          if (!this.hasAccessToLesson(target.id)) {
            this.setResult(false, 'üîí Next lesson is locked. Get 3 correct in a row to unlock.');
            return;
          }
          this.lessonIdx = idx;
          this.selectedLessonId = String(target.id);
          const freshLesson = await this.loadLesson(target.id);
          this.setLessonBody(this.cleanProblemText(freshLesson.body_md) || '');
          this.problems = await this.loadProblems(target.id);
          this.problemIdx = 0;
          this.successCount = 0;
          this.showProblem();
        },

        async setLessonById(id) {
          const idx = this.lessons.findIndex(l => l.id === Number(id));
          if (idx >= 0) {
            await this.setLessonByIndex(idx);
          }
        },

        async refreshLesson() {
          if (!this.lessons.length) return;
          const current = this.lessons[this.lessonIdx];
          const lesson = await this.loadLesson(current.id);
          this.setLessonBody(this.cleanProblemText(lesson.body_md) || '');
        },

        showProblem() {
          this.clearAdvanceTimer();
          this.answer = '';
          this.hideResult();
          this.$nextTick(() => {
            if (!this.showLogin && this.$refs.answerInput) {
              this.$refs.answerInput.focus();
            }
          });
        },

        prevProblem() {
          if (!this.problems.length) return;
          this.clearAdvanceTimer();
          this.problemIdx = (this.problemIdx - 1 + this.problems.length) % this.problems.length;
          this.showProblem();
        },

        nextProblem() {
          if (!this.problems.length) return;
          this.clearAdvanceTimer();
          this.problemIdx = (this.problemIdx + 1) % this.problems.length;
          this.showProblem();
        },

        async check() {
          if (this.showLogin) return;
          if (this.isRevealed) {
            this.setResult(false, 'You revealed this one. Try the next problem.');
            return;
          }
          const input = (this.answer || '').trim();
          if (!input) {
            this.setResult(false, 'Type your answer first');
            return;
          }
          try {
            const p = this.currentProblem;
            if (!p) {
              this.setResult(false, 'No problem selected');
              return;
            }
            const res = await this.backendValidate(p.id, input);
            this.recordAttempt(p.id, input, res);
            if (res.ok) {
              const stage = res.stage ? ` (${res.stage})` : '';
              this.setResult(true, 'Correct!' + stage);
              this.successCount++;
              if (this.successCount >= 3) {
                this.openCongrats();
              }
              if (this.advanceOnCorrect) {
                this.clearAdvanceTimer();
                this.advanceTimerId = setTimeout(() => {
                  if (!this.showModal && !this.showLogin) {
                    this.nextProblem();
                  }
                  this.clearAdvanceTimer();
                }, this.advanceDelayMs);
              }
            } else {
              let msg = res.error || 'Incorrect.';
              if (res.details && res.details.failures) {
                const f = res.details.failures[0];
                if (f && f.expr) msg += `\nFailed test: ${f.expr}`;
              }
              this.setResult(false, msg);
            }
          } catch (e) {
            this.setResult(false, e.message || 'Backend validation failed.');
          }
        },

        reveal() {
          if (this.showLogin) return;
          if (this.isRevealed) return;
          this.openRevealConfirm();
        },

        openRevealConfirm() {
          this.showRevealConfirm = true;
          this.$nextTick(() => {
            if (this.$refs.revealModal) {
              this.$refs.revealModal.focus();
            }
          });
        },

        cancelReveal() {
          this.showRevealConfirm = false;
        },

        async confirmReveal() {
          this.showRevealConfirm = false;
          const p = this.currentProblem;
          const ans = p?.answer_text || 'N/A';
          if (p) {
            this.revealedById[p.id] = true;
          }
          this.setResult(true, 'Answer: ' + ans + ' ‚Äî (This problem is marked as revealed and won\'t count toward your streak)');
          this.clearAdvanceTimer();
          this.advanceTimerId = setTimeout(() => {
            if (!this.showModal && !this.showLogin) {
              this.nextProblem();
            }
            this.clearAdvanceTimer();
          }, this.advanceDelayMs);
        },

        shuffle() {
          for (let i = this.problems.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.problems[i], this.problems[j]] = [this.problems[j], this.problems[i]];
          }
          this.problemIdx = 0;
          this.showProblem();
        },

        // ====== Modal controls for next-lesson flow ======
        openCongrats() {
          this.showModal = true;
        },

        closeCongrats() {
          this.showModal = false;
        },

        async confirmAdvanceLesson() {
          this.closeCongrats();
          if (!this.username) {
            this.setResult(false, 'Please sign in first.');
            return;
          }
          try {
            const res = await fetch(`${this.API_BASE}/users/by-username/${encodeURIComponent(this.username)}/advance`, {
              method: 'POST'
            });
            if (!res.ok) {
              const text = await res.text().catch(() => '');
              throw new Error(text || `Advance failed (${res.status})`);
            }
            const updated = await res.json();
            this.user = updated;
            this.username = updated.username;
            this.userId = updated.user_id;
            localStorage.setItem('username', this.username);
            this.successCount = 0;
            if (updated.active_lesson) {
              await this.setLessonById(updated.active_lesson);
              this.setResult(true, 'Next lesson unlocked!');
            }
          } catch (e) {
            this.setResult(false, e?.message || 'Could not advance to next lesson.');
          }
        },

        resetStreakAndStay() {
          this.successCount = 0;
          this.closeCongrats();
        },
      },

      async mounted() {
        await this.init();

        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey) {
            if (!this.showLogin && !this.isRevealed) {
              e.preventDefault();
              this.check();
            }
          } else if (e.key === 'Enter' && e.ctrlKey) {
            if (!this.showLogin && !this.isRevealed) {
              e.preventDefault();
              this.reveal();
            }
          }
        });
      },

      beforeUnmount() {
        this.clearAdvanceTimer();
      }
    }).mount('#app');
  </script>
</body>
</html>