<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>S-Expression Practice</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121935; --muted:#8ea0c6; --text:#e8eeff; --accent:#6aa6ff; --ok:#31d061; --err:#ff6b6b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:linear-gradient(180deg,#0b1020,#0d1330 40%,#0e1738)}
    header{padding:20px 24px;border-bottom:1px solid #1c2550;background:rgba(0,0,0,.2);backdrop-filter: blur(6px);position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:20px;letter-spacing:.3px}
    main{display:grid;gap:18px;padding:18px;grid-template-columns: 1fr 1fr;align-items:start}
    @media (max-width: 980px){main{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid #1c2550;border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card header{position:static;background:transparent;border:0;padding:16px 16px 0}
    .card .content{padding:16px}
    .muted{color:var(--muted)}
    textarea,input,select,button{font:inherit;color:inherit}
    textarea{width:100%;min-height:300px;background:#0e1430;border:1px solid #243067;border-radius:12px;padding:12px;color:var(--text)}
    select{background:#0e1430;border:1px solid #243067;border-radius:12px;padding:8px 10px;color:var(--text)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .stack{display:grid;gap:12px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid #26306a;background:#0f1636;border-radius:999px;font-size:12px;color:var(--muted)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0b1130;border:1px solid #2a3574;border-bottom-width:2px;border-radius:6px;padding:2px 6px;color:#cfe2ff}
    .panel{background:#0e1430;border:1px dashed #2a3574;border-radius:12px;padding:12px}
    .input{width:100%;background:#0e1430;border:1px solid #243067;border-radius:12px;padding:12px}
    .btn{background:linear-gradient(180deg,#2563eb,#1d4ed8);border:0;color:white;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s transform, .2s filter;box-shadow:0 6px 18px rgba(37,99,235,.3)}
    .btn.secondary{background:#0f1636;border:1px solid #2a3574;color:#cfe2ff;box-shadow:none}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .status{border-radius:12px;padding:12px}
    .status.ok{background:rgba(49,208,97,.1);border:1px solid rgba(49,208,97,.35)}
    .status.err{background:rgba(255,107,107,.08);border:1px solid rgba(255,107,107,.35)}
    .small{font-size:12px}
    code{background:#0b1130;border:1px solid #2a3574;border-radius:8px;padding:1px 6px}
    .footer{padding:10px 16px;border-top:1px solid #1c2550;display:flex;justify-content:space-between;align-items:center;gap:8px;border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius)}
    /* Modal */
    .modal{display:none;position:fixed;z-index:100;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);align-items:center;justify-content:center}
    .modal-content{background:#121935;padding:20px;border-radius:16px;max-width:420px;text-align:center;border:1px solid #1c2550}
    .modal-content h2{margin:4px 0 10px}
    .lesson-display {
    white-space: pre-wrap;
    background:#0e1430;
    border:1px solid #243067;
    border-radius:12px;
    padding:12px;
    color:var(--text);
    }
    .lesson-display p {
    margin: 0 0 0.5em;  /* no top margin, small bottom margin */
    }
    .lesson-display code {
    font-family: monospace;
    background:#0b1130;
    border:1px solid #2a3574;
    border-radius:6px;
    padding:2px 4px;
    }



  </style>
</head>
<body>
  <header>
    <h1>S-Expression Practice ‚Ä¢ Lesson + Validator</h1>
  </header>

  <main>
    <!-- LEFT: Lesson text -->
    <section class="card" id="lessonCard">
      <header>
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0;font-size:18px">Lesson</h2>
          <div class="row">
            <span class="pill">Tip: press <span class="kbd">Enter</span> on the right to check</span>
          </div>
        </div>
        <div class="row" style="margin:10px 0 0">
          <!-- Lesson navigation -->
          <button class="btn secondary" id="lessonPrevBtn">‚óÄ Prev lesson</button>
          <select id="lessonSelect" aria-label="Choose lesson"></select>
          <button class="btn secondary" id="lessonNextBtn">Next lesson ‚ñ∂</button>
        </div>
      </header>
      <div class="content">
        <div class="stack">
          <!-- <textarea id="lessonText" spellcheck="false" disabled></textarea> -->
           <!-- <pre id="lessonText" class="lesson-display" aria-live="polite"></pre> -->
            <div id="lessonText" class="lesson-display"></div>

          <div class="row" style="justify-content:flex-end">
            <button class="btn secondary" id="refreshLessonBtn" hidden>Refresh from server</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Problems & validator -->
    <section class="card" id="practiceCard">
      <header>
        <h2 style="margin:0 0 6px 0;font-size:18px">Problems & Validator</h2>
        <div class="muted small">Your answer is validated by the backend (CFG or Racket), based on the lesson/problem config.</div>
      </header>
      <div class="content">
        <div class="stack">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="row" style="gap:16px">
              <label class="pill"><input type="checkbox" id="naryToggle" /> Allow n-ary (‚â•2 operands)</label>
              <label class="pill"><input type="checkbox" id="allowNeg" /> Allow negative integers</label>
            </div>
            <div class="row">
              <button class="btn secondary" id="prevBtn">‚óÄ Prev</button>
              <button class="btn secondary" id="nextBtn">Next ‚ñ∂</button>
            </div>
          </div>

          <div class="panel">
            <div class="muted small">Problem</div>
            <div id="problemText" style="font-size:22px;margin-top:6px"></div>
          </div>

          <label class="muted small" for="answerInput">Your answer</label>
          <input id="answerInput" class="input" placeholder="e.g. (+ 5 4) or Racket code" autocomplete="off" />

          <div class="row" style="justify-content:flex-start;gap:10px">
            <button class="btn" id="checkBtn">Check (Enter)</button>
            <button class="btn secondary" id="revealBtn">Reveal answer</button>
            <button class="btn secondary" id="shuffleBtn">Shuffle</button>
          </div>

          <div id="result" class="status" style="display:none"></div>

          <!-- <details>
            <summary class="muted">Show CFG used for S-expression parsing (informational)</summary>
            <pre id="cfgBox" style="white-space:pre-wrap"></pre>
          </details> -->
        </div>
      </div>
      <div class="footer small muted">
        <div>Keyboard: <span class="kbd">Enter</span> to check ‚Ä¢ <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> to reveal</div>
        <!-- <div>Strict binary by default; toggle n-ary if you teach <code>(+ 1 2 3)</code>.</div> -->
      </div>
    </section>
  </main>

  <!-- Congrats Modal -->
  <div class="modal" id="congratsModal">
    <div class="modal-content">
      <h2>üéâ Congratulations!</h2>
      <p>You solved 3 problems correctly in a row!</p>
      <div class="row" style="justify-content:center;margin-top:12px;gap:10px">
        <button class="btn" id="keepGoingBtn">Keep going</button>
        <button class="btn secondary" id="resetCounterBtn">Reset counter</button>
      </div>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
  // ====== Config ======
  const API_BASE = "http://localhost:8000"; // FastAPI base

  // ====== Backend I/O ======
  async function listLessons() {
    const res = await fetch(`${API_BASE}/lessons`);
    if (!res.ok) throw new Error("Failed to list lessons");
    return await res.json();
  }

  async function loadLesson(lessonId) {
    const res = await fetch(`${API_BASE}/lessons/${lessonId}`);
    if (!res.ok) throw new Error("Lesson not found");
    return await res.json(); // {id,title,body_md,(optional validator fields)}
  }

  async function loadProblems(lessonId) {
    const res = await fetch(`${API_BASE}/lessons/${lessonId}/problems`);
    if (!res.ok) throw new Error("Failed to load problems");
    return await res.json(); // [{id, lesson_id, prompt_text, answer_text, ...}]
  }

  async function backendValidate(problemId, submission) {
    const res = await fetch(`${API_BASE}/validate`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ problem_id: problemId, submission })
    });
    if (!res.ok) {
      const text = await res.text().catch(()=> "");
      throw new Error(`Backend error (${res.status}): ${text || 'unknown'}`);
    }
    return await res.json(); // {ok, stage, error?, details?}
  }

  // ====== (Optional) CFG text for info panel ======
  function getCfgText(nary, allowNeg){
    return (
`S        ::= WS? Expr WS?\n\n`+
`Expr     ::= Int\n`+
`           | "(" WS? Op WS Expr ` + (nary? '(WS Expr)+' : 'WS Expr') + ` WS? ")"\n\n`+
`Op       ::= "+" | "-" | "*"\n\n`+
`Int      ::= ` + (allowNeg? `'["-"] ("0" | NonZeroDigit {Digit})'` : '`"0" | NonZeroDigit {Digit}`') + `\n`+
`Digit    ::= "0" | NonZeroDigit\n`+
`NonZeroDigit ::= "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9"\n\n`+
`WS       ::= {" " | "\\t" | "\\n" | "\\r"}`
    );
  }

  // ====== UI wiring & state ======
  const els = {
    lessonText: document.getElementById('lessonText'),
    refreshLessonBtn: document.getElementById('refreshLessonBtn'),
    lessonSelect: document.getElementById('lessonSelect'),
    lessonPrevBtn: document.getElementById('lessonPrevBtn'),
    lessonNextBtn: document.getElementById('lessonNextBtn'),

    problemText: document.getElementById('problemText'),
    answerInput: document.getElementById('answerInput'),
    result: document.getElementById('result'),
    naryToggle: document.getElementById('naryToggle'),
    allowNeg: document.getElementById('allowNeg'),
    cfgBox: document.getElementById('cfgBox'),
    checkBtn: document.getElementById('checkBtn'),
    revealBtn: document.getElementById('revealBtn'),
    shuffleBtn: document.getElementById('shuffleBtn'),
    prevBtn: document.getElementById('prevBtn'),
    nextBtn: document.getElementById('nextBtn'),
    congratsModal: document.getElementById('congratsModal'),
    keepGoingBtn: document.getElementById('keepGoingBtn'),
    resetCounterBtn: document.getElementById('resetCounterBtn'),
  };

  let lessons = [];          // [{id,title,body_md}, ...]
  let lessonIdx = 0;         // index into lessons[]
  let problems = [];         // problems for current lesson
  let problemIdx = 0;
  let successCount = 0;

  function hideResult(){ els.result.style.display='none'; }
  function showOk(msg){ const el=els.result; el.className='status ok'; el.style.display='block'; el.textContent = '‚úÖ ' + msg; }
  function showErr(msg){ const el=els.result; el.className='status err'; el.style.display='block'; el.textContent = '‚ùå ' + msg; }

function setLessonBody(md){
  // convert Markdown ‚Üí HTML
  els.lessonText.innerHTML = marked.parse(md || '');
}


function showProblem(){
  if(!problems.length){ els.problemText.textContent = 'No problems found for this lesson.'; return; }
  const p = problems[problemIdx];
  els.problemText.textContent = cleanProblemText(p.prompt_text);
  els.answerInput.value = '';
  els.answerInput.focus();
  hideResult();
}


  function showCFG(){ els.cfgBox.textContent = getCfgText(els.naryToggle.checked, els.allowNeg.checked); }

  function openCongrats(){ els.congratsModal.style.display='flex'; }
  function closeCongrats(){ els.congratsModal.style.display='none'; }

  async function setLessonByIndex(newIdx) {
    if (!lessons.length) return;
    lessonIdx = (newIdx + lessons.length) % lessons.length;
    const current = lessons[lessonIdx];

    // Update dropdown selection
    els.lessonSelect.value = String(current.id);

    // Load the latest lesson body
    const freshLesson = await loadLesson(current.id);
    // els.lessonText.value = freshLesson.body_md || '';
    setLessonBody(cleanProblemText(freshLesson.body_md) || '');

    // Load problems for this lesson
    problems = await loadProblems(current.id);
    problemIdx = 0;
    successCount = 0; // reset streak per lesson
    showProblem();

    // Update lesson nav button disabled state
    els.lessonPrevBtn.disabled = lessons.length <= 1;
    els.lessonNextBtn.disabled = lessons.length <= 1;
  }

  async function setLessonById(id) {
    const idx = lessons.findIndex(l => l.id === Number(id));
    if (idx >= 0) {
      await setLessonByIndex(idx);
    }
  }

    async function recordAttempt(problemId, submission, backendResult) {
    try {
        await fetch(`${API_BASE}/attempts`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
            problem_id: problemId,
            submitted_text: submission,
            is_correct: !!backendResult.ok,
            stage: backendResult.stage || null,
            error_reason: backendResult.ok ? null : (backendResult.error || null),
            details: backendResult.details || null
        })
        });
    } catch (e) {
        console.warn("Failed to record attempt:", e);
    }
    }


async function check(){
  const input = els.answerInput.value.trim();
  if(!input){ showErr('Type your answer first'); return; }

  try {
    const p = problems[problemIdx];
    const res = await backendValidate(p.id, input);

    // record attempt regardless of correctness
    recordAttempt(p.id, input, res);

    if (res.ok) {
      const stage = res.stage ? ` (${res.stage})` : '';
      showOk('Correct!' + stage);
      successCount++;
      if(successCount === 3){ openCongrats(); }
    //   setTimeout(()=>{ problemIdx=(problemIdx+1)%problems.length; showProblem(); }, 600);
    } else {
      let msg = res.error || 'Incorrect.';
      if (res.details && res.details.failures) {
        const f = res.details.failures[0];
        if (f && f.expr) msg += `\nFailed test: ${f.expr}`;
      }
      showErr(msg);
    }
  } catch (e) {
    showErr(e.message || 'Backend validation failed.');
  }
}

function cleanProblemText(raw){
  if (typeof raw !== 'string') return '';
  // turn "\n" into actual newlines, trim edges
  return raw.replaceAll('\\n', '\n').trim();
}


  function reveal(){ showOk('Answer: ' + (problems[problemIdx]?.answer_text || 'N/A')); }

  function shuffle(){
    for(let i=problems.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [problems[i],problems[j]]=[problems[j],problems[i]]; }
    problemIdx=0; showProblem();
  }

  // ====== Events ======
  els.checkBtn.addEventListener('click', check);
  els.revealBtn.addEventListener('click', reveal);
  els.shuffleBtn.addEventListener('click', shuffle);

  els.prevBtn.addEventListener('click', ()=>{ if(!problems.length) return; problemIdx=(problemIdx-1+problems.length)%problems.length; showProblem(); });
  els.nextBtn.addEventListener('click', ()=>{ if(!problems.length) return; problemIdx=(problemIdx+1)%problems.length; showProblem(); });

  els.naryToggle.addEventListener('change', showCFG);
  els.allowNeg.addEventListener('change', showCFG);

  els.refreshLessonBtn.addEventListener('click', async()=>{
    if (!lessons.length) return;
    const current = lessons[lessonIdx];
    const lesson = await loadLesson(current.id);
    // els.lessonText.value = lesson.body_md || '';
    setLessonBody(cleanProblemText(lesson.body_md) || '');
  });

  // Lesson navigation
  els.lessonPrevBtn.addEventListener('click', async ()=>{ await setLessonByIndex(lessonIdx - 1); });
  els.lessonNextBtn.addEventListener('click', async ()=>{ await setLessonByIndex(lessonIdx + 1); });
  els.lessonSelect.addEventListener('change', async (e)=>{ await setLessonById(e.target.value); });

  // Modal buttons
  els.keepGoingBtn.addEventListener('click', ()=>{ closeCongrats(); });
  els.resetCounterBtn.addEventListener('click', ()=>{ successCount = 0; closeCongrats(); });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey && !e.ctrlKey){
      if(document.activeElement===els.answerInput || document.activeElement===document.body){
        e.preventDefault(); check();
      }
    }
    if(e.key==='Enter' && e.ctrlKey){ e.preventDefault(); reveal(); }
  });

  // ====== Bootstrap ======
  (async ()=>{
    try{
      lessons = await listLessons();
      els.lessonSelect.innerHTML = lessons.map(l => `<option value="${l.id}">${l.title} (ID ${l.id})</option>`).join('');
      await setLessonByIndex(0);
    } catch(err){
      console.error(err);
      els.lessonSelect.innerHTML = `<option>(no lessons found)</option>`;
      els.lessonPrevBtn.disabled = true;
      els.lessonNextBtn.disabled = true;
      document.getElementById('problemText').textContent = 'No lessons found. Please add one in the database.';
    }
    showCFG();
  })();
  </script>
</body>
</html>
